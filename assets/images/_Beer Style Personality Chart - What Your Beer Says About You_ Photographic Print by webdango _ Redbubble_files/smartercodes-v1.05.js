!function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);let i=$smcT5,r=($smcJQ,i.CookieManager),o=i.tagHelpers,a=i.outputs,s=i.LS,c=o.DBC,d=o.DBW,u=(o.DBE,o.getURL()),l=o.get,p=o.referrerDomain,h=o.functionizer,v=o.ajax.post,f=void 0===window.$smcDebugger?0:1,y=a.smarterCodes.endpoint,g=a.smarterCodes.campaign_id;var m=i;function k(e,t){return this.options={seconds:.5,decay:1.4,max:10,callback:e},this.options={...this.options,...t},this.timer=this.options.seconds,this.timeout=null,this.running=void 0,this.expired=void 0,this}k.prototype.start=function(){(this.running||void 0===this.running)&&(this.running=!0),this.cycle()},k.prototype.reset=function(){this.timer=this.options.seconds,this.start()},k.prototype.cycle=function(){if(this.running){if(this.timer>this.options.max)return this.stop(),this.expired=!0,void this.options.callback.apply(this);clearTimeout(this.timeout);var e=this;this.timeout=setTimeout(function(){e.options.callback.apply(e),e.cycle.apply(e)},1e3*this.timer),this.timer=this.timer*this.options.decay}},k.prototype.stop=function(){this.running&&(this.running=!1)};var C=k;let b="SMC VCC: ";function x(e,t,n){let i=t=>[].forEach.call(e,function(e){e.addEventListener(t,n,!1)});return Array.isArray(t)?t.forEach(e=>i(e)):i(t)}let I=!1;var T=function(e,t,n,i,r){if(!e||"String"!==e.constructor.name)throw new Error("Code requires a valid string to create an instance");if(I||(I=_.config),this.code=e||"",this.campaignId=I.campaignId,this.origin=t||void 0,this.valid=void 0!==n?n:void 0,this.dataSent=void 0!==i&&i,this.message=void 0!==r?r:"",this.activeCheck=!1,this.status={key:void 0,name:void 0},this.basket=this.delivery=this.sums={value:0,discount:0,percent:0},this.dynamicKeys=I.dynamicKeys,void 0!==this.valid)return this;var o=I.validCheck;if(o.trigger)if("pageLoad"===o.trigger.event)c(b,`Not checking code '${this.code}' immediately, setting page load trigger`),"cookie"===t&&this.check();else{let e=o.trigger;c(b,`Not checking code '${this.code}' immediately, setting custom trigger ${e.event} on ${e.selector}`),document.querySelector(e.selector).addEventListener(e.event,this.check)}else this.check()};T.prototype.check=function(){if(c(b,"Checking if code is valid..."),void 0!==this.valid)return!1;var e=this,t=I.validCheck?I.validCheck:{},n=I.invalidCheck?I.invalidCheck:{};let i;var r=function(){};t.method&&""!==t.selector&&n.method&&""!==n.selector?r=function(){c(b,"check..."),e.activeCheck.expired?s():u(n)?a(!1):u(t)&&a(!0)}:(i=t.method&&""!==t.selector?t:n,r=function(){e.activeCheck.expired?s():u(i)&&a(!0)});var o=I.decay?I.decay:{seconds:.5,decay:1.4,max:10};function a(t){e.valid=t,e.updateValues(),e.updateStatus(t),e.activeCheck.stop(),e.sendData(),e.dataSent=!0,_.updateCookie(),c(b,t?"Valid":"Invalid condition found. Checks stopped")}function s(){c(b,"The Decay check has expired, defaulting to: ",I.validCheck.default),void 0!==I.validCheck.default&&a(I.validCheck.default)}function u(e){var t,n=document.querySelector(e.selector);if(null===n)return d(b,"Tried to apply the method : ",e.method," to the element : ",e.selector),!1;switch(c(b,"element Exists : ",n),e.method){case"elementExists":return n.length>0;case"elementVisible":return function(){if(!(n&&n instanceof HTMLElement))return!1;var e=window.getComputedStyle(n);return!("none"===e.display||"hidden"===e.visibility)}();case"elementAttribute":return n.getAttribute(e.attribute)===e.attributeValue;case"elementClass":return!!n.classList.contains(e.class);case"elementIsEqual":return t="text"===e.ruleType?n.innerText:"html"===e.ruleType?n.innerHTML:void 0,!!new RegExp(`^${e.ruleValue}$`).exec(t);case"elementContains":return function(){var t="text"===e.ruleType?n.innerText:"html"===e.ruleType?n.innerHTML:void 0;return!!new RegExp(`${e.ruleValue}`).exec(t)}();case"elementStartsWith":return function(){var t="text"===e.ruleType?n.innerText:"html"===e.ruleType?n.innerHTML:void 0;return!!new RegExp(`^${e.ruleValue}`).exec(t)}();case"elementEndsWith":return function(){var t="text"===e.ruleType?n.innerText:"html"===e.ruleType?n.innerHTML:void 0;return!!new RegExp(`${e.ruleValue}$`).exec(t)}();case"elementIsEmpty":return""===("text"===e.ruleType?n.innerText:"html"===e.ruleType?n.innerHTML:void 0);case"elementRegex":return function(){var t="text"===e.ruleType?n.innerText:"html"===e.ruleType?n.innerHTML:void 0;return!!new RegExp(e.ruleValue).exec(t)}()}}this.activeCheck=new C(r,o),this.activeCheck.start()},T.prototype.prepareData=function(e,t,n){c(b,"Preparing data on code");var i="{}";try{i=JSON.parse(atob(e))}catch(e){c(b,"smct_sources does not exist in LS - may cause missing data")}let o=p(),a={values:{basket:{value:t.basket.value,discount:t.basket.discount,percentage:t.basket.percent},delivery:{value:t.delivery.value,discount:t.delivery.discount,percentage:t.delivery.percent},total:{value:t.sums.value,discount:t.sums.discount,percentage:t.sums.percent}}};var s={};for(var d in t.dynamicKeys)void 0!==$smcT5.outputs.dynamic[t.dynamicKeys[d]]&&(s[t.dynamicKeys[d]]=$smcT5.outputs.dynamic[t.dynamicKeys[d]]);Object.keys(s).length>0&&(a.dynamicKeys=s);var u=r.read("smc_vcc_sale_count");(u=parseInt(u))?u++:u=1,n({sources:i,domain_referrer_id:o,meta:a,user_id:l("uid"),tag_index:l("id"),device_id:l("dv").id,code:t.code,success:t.valid?1:0,message:t.message,debug:f,status_key:t.status.key,campaign_id:t.campaignId,sales_count:u},t)},T.prototype.collectData=function(e,t){c(b,"Collecting data on code");var n="smct_sources_"+l("id").toString(),i=this;s.get(n,function(n){e(n,i,t)})},T.prototype.updateValues=function(){c(b,"Updating values");var e=this,t=this.valid?I.validCheck:I.invalidCheck;t=t||{};var n={value:0,discount:0,percent:0};function i(t){var n,i=0,o=0;return n=t.value?r(t.value,!0):0,e.valid&&(i=t.discount?r(t.discount,!0):0,o=t.percent?r(t.percent,!0):0),function(e,t,n,i=!1){let r={value:e,discount:t,percent:n};if(e>0&&(0!==t||0!==n)){if(0===t){let r;i?(r=e,e*=1+n/100):r=e-e*(n/100),t=e-r}else 0===n&&(n=t/(e=i?e+t:e)*100);r={value:e,discount:t,percent:n},Object.keys(r).forEach(e=>r[e]=Math.round(100*r[e])/100)}return r}(n,i,o)}function r(e,t){var n=document.querySelector(e.selector);if(!n)return t?0:"";switch(e.type){case"text":return t?o(n.innerText):n.innerText;case"html":return t?o(n.innerHTML):n.innerHTML;case"attribute":return t?o(n.getAttribute(e.attrName)):n.getAttribute(e.attrName);case"textNoChild":return t?o(a(n)):a(n)}}function o(e){var t=h(e,[{type:"special",vals:[]}]);return null===t||""===t?0:t}function a(e){let t=e.firstChild,n=[];for(;t;)3===t.nodeType&&n.push(t.data),t=t.nextSibling;return n.join("")}this.message=t.message?r(t.message):"",this.basket=I.basket?i(I.basket):n,this.delivery=I.delivery?i(I.delivery):n,this.message=this.message?this.message.trim():"",this.sums=function(){var t=Math.round(100*(e.basket.value+e.delivery.value))/100,n=Math.round(100*(e.basket.discount+e.delivery.discount))/100;let i=n/t*100;return i=i?Math.round(100*i)/100:0,{value:t,discount:n,percent:i}}()},T.prototype.prepareToPost=function(e,t){let n=JSON.stringify(e);if(n={d:f?n:btoa(n)},f){let e={value:{basket:t.basket.value,delivery:t.delivery.value,sum:t.sums.value},discount:{basket:t.basket.discount,delivery:t.delivery.discount,sum:t.sums.discount},percent:{basket:t.basket.percent,delivery:t.delivery.percent,sum:t.sums.percent}};d(b,"\nCode: ",t.code,"\nResult:",t.valid?"valid":"invalid",""),console.table(e)}v(y+"?handle=code-store",n,function(e){if(f&&e)try{e=JSON.parse(e),c(b," smcdz-ep res: ",e)}catch(t){c(b,"smcdz-ep res, JSON.parse fail: ",e)}})},T.prototype.sendData=function(){if(this.dataSent)return c(b,"Code.sendData(): Data already sent. Will not send twice."),!1;this.dataSent=!0,c(b,"Posting results to the back end \nCode: "+this.code+"\nValid Code: "+this.valid),this.collectData(this.prepareData,this.prepareToPost)},T.prototype.stringify=function(){return c(b,"Stringify data of code object"),JSON.stringify({code:this.code,valid:this.valid,dataSent:this.dataSent,message:this.message})},T.prototype.updateStatus=function(e){return e?(this.basket.discount>0&&this.delivery.discount>0?this.status={name:"valid basket delivery",key:1}:this.basket.discount>0?this.status={name:"valid basket",key:2}:this.delivery.discount>0?this.status={name:"valid delivery",key:3}:0===this.delivery.discount&&0===this.basket.discount?this.status={name:"valid",key:4}:this.status={name:"uncaught",key:null},!0):(this.status={name:"invalid",key:0},!1)};var S=T,w=function(){return this.readHistory=function(){c(b,"Reading code history of user");var e=r.read("smc_vcc_history");return null===e?[]:e.split(",,").map(function(e){try{let t=JSON.parse(e);return new S(t.code,"cookie",t.valid,t.dataSent,t.message)}catch(e){return void(f&&d(b,"Failed to parse existing Codes from cookie: ",e))}})},this.updateConfig=function(){let e=this;v(y+"?handle=campaign",{cid:g},function(t){try{t=JSON.parse(t)}catch(e){return void(f&&d(b,"Config parse failure: ",e,t))}if(c(b,"config res:",t),1==t.r)if(1==t.setup.active){if(e.config=function(e){var t,n,i=e.campaign_data.dom_setup;return{url:i.url&&""!==i.url?i.url:void 0,checkForInput:"1"===i.checkForInput,updateInputOnCodeCreation:"1"===i.updateInputOnCodeCreation,codeInput:(n=i.codeInput,"string"==typeof n?n:"invalid_selector"),decay:function(e){let t=e.seconds?parseFloat(e.seconds):NaN,n=e.decay?parseFloat(e.decay):NaN,i=e.max?parseFloat(e.max):NaN;return{seconds:!isNaN(t)&&t>0?t:.5,decay:!isNaN(n)&&n>1?n:1.4,max:!isNaN(i)&&i>0?i:10}}(i.decay),dynamicKeys:function(e){var t={};if(void 0!==e&&""!==e)try{var n=JSON.parse(e);t=n}catch(e){}return t}(i.dynamicKeys),newCode:(t=i.newCode,{enterKey:"1"===t.enterKey,method:"string"==typeof t.method?t.method:"elementVisible",selector:"string"==typeof t.selector?t.selector:""}),validCheck:""!==i.validCheck.selector||"undefined"!==i.validCheck.trigger.event?r(i.validCheck):void 0,invalidCheck:""!==i.invalidCheck.selector||"undefined"!==i.invalidCheck.trigger.event?r(i.invalidCheck):void 0,basket:o(i.basket),delivery:o(i.delivery),campaignId:e.campaign_id};function r(e){return{...e,default:"0"!==e.default&&("1"===e.default||void 0),message:"undefined"===e.message.type?void 0:e.message,trigger:"undefined"===e.trigger.event?void 0:e.trigger}}function o(e){return"undefined"!==e.value.type&&(e.value.includesDiscount="1"===e.value.includesDiscount),{value:"undefined"!==e.value.type?e.value:void 0,discount:"undefined"!==e.discount.type?e.discount:void 0,percent:"undefined"!==e.percent.type?e.percent:void 0}}}(t.setup),c(b,"Smarter Codes is running. URL to match:",e.config.url,u.match(e.config.url)),void 0!==e.config.url&&null===u.match(e.config.url))return c(b,"Config URL is defined but does not match current URL"),!1;e.setupCodeTrigger()}else c(b,"Smarter Codes is Off");else d(b,"Smarter Codes - Not Loaded: ",t.msg||t.errors)})},this.updateConfig(),this.setupCodeInput=function(e){var t=this;let n=e=>(x(e,["keydown","paste","cut","change"],function(e){t.activeCodeInput!==e.target&&(t.activeCodeInput=e.target)}),e);if(!this.config.checkForInput)return t.codeInput=document.querySelectorAll(t.config.codeInput),t.activeCodeInput=t.codeInput[0],n(t.codeInput),e(),t.codeInput;var i,r=new C(function(){(i=document.querySelectorAll(t.config.codeInput)).length>0&&(r.stop(),t.codeInput=i,t.activeCodeInput=t.codeInput[0],n(t.codeInput),e())},{seconds:.1,decay:1.05,max:100});r.start()},this.setupCodeTrigger=function(){var e=this;function t(t){e.config.updateInputOnCodeCreation&&e.updateCodeInputReference();let n=e.activeCodeInput.value;if(!(""===n||n.indexOf(",,")>-1)){var i=function(e,t){return new S(e,t)}(n,t.target);c(b,"smcCodeCreateTrigger(): New code created: ",i),e.checkCodeHistory(i)?i.activeCheck&&i.activeCheck.running&&(i.activeCheck.stop(),c(b,"Code already exists in user history. No need to add to history.",i)):e.addToHistory(i)}}this.setupCodeInput(function(){c(b,"Creating new code triggers");var n=e.config.newCode;switch(n.method){case"buttonClick":!function(e){let n=document.querySelectorAll(e);c(b,"Setting up button click trigger on: ",n||"document"),n&&document.addEventListener("click",function(i){i.target&&([].indexOf.call(n,i.target)>-1||i.target.matches(` ${e}, ${e} * `))&&t(i)})}(n.selector);break;case"inputChange":x(e.codeInput,"change",t)}c(b,"trigger.enterKey = ",n.enterKey),n.enterKey&&(c(b,"Setting up enter key trigger on: ",e.codeInput),x(e.codeInput,"keydown",function(n){n.target!==e.activeCodeInput&&(e.activeCodeInput=n.target),13===n.keyCode&&t(n)})),e.codeHistory=e.readHistory()})},this.updateCodeInputReference=function(){c(b,"Updating input reference");var e=this;return e.codeInput=document.querySelectorAll(e.config.codeInput),e.activeCodeInput=e.codeInput[0],(t=>(x(t,["keydown","paste","cut","change"],function(t){e.activeCodeInput!==t.target&&(e.activeCodeInput=t.target)}),t))(e.codeInput),e.codeInput},this.checkCodeHistory=function(e){if(!(e instanceof S))throw new Error("User can only check Code objects against history");c(b,"Checking if code exists in history");var t=!1;return this.codeHistory.forEach(function(n){n.code===e.code&&(t=!0)}),t},this.updateCookie=function(){var e=this.codeHistory.map(function(e){return e.stringify()});r.create("smc_vcc_history",e.join(",,"))},this.addToHistory=function(e){if(!(e instanceof S))throw new Error("User can only add Code objects to history");c(b,"Adding code to user history"),this.codeHistory.push(e),this.updateCookie()},this};m.vcc="User instance not yet created. Ensure input can be found on page, then User will be created.",m.vcc=new w;var _=t.default=m.vcc}]);